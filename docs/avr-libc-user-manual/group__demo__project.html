<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<title>AVR-LibC: A simple project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dox.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AVR-LibC
   &#160;<span id="projectnumber">2.3.0</span>
   </div>
   <div id="projectbrief">Standard C library for AVR-GCC</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table>
  <tr>
    <td align="left"><a href="https://avrdudes.github.io/avr-libc/"><h2>AVR-LibC Manual</h2></a></td>
    <td align="center" colspan=4>
      <div class="logo"><img src="avr-libc-logo.png" alt="Logo" align="middle" border="0"></div>
      <div class="invlogo"><img src="avr-libc-logo-inverted.png" alt="Logo" align="middle" border="0"></div>
    </td>
    <td align="right"><a href="https://github.com/avrdudes/avr-libc/"><h2>AVR-LibC Sources</h2></a></td>
  </tr>
  <tr>
    <td align="center" width="14%"><a href="index.html"><h2>Main Page</h2></a></td>
    <td align="center" width="16%"><a href="pages.html"><h2>User Manual</h2></a></td>
    <td align="center" width="22%"><a href="modules.html"><h2>Lib&shy;rary Refe&shy;rence</h2></a></td>
    <td align="center" width="7%"><a href="FAQ.html"><h2>FAQ</h2></a></td>
    <td align="center" width="22%"><a href="group__demos.html"><h2>Exam&shy;ple Pro&shy;jects</h2></a></td>
    <td align="center" width="14%"><a href="Global_01Index.html"><h2>Index</h2></a></td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">A simple project<div class="ingroups"><a class="el" href="group__demos.html">Demo projects</a></div></div></div>
</div><!--header-->
<div class="contents">
<p>At this point, you should have the GNU tools configured, built, and installed on your system. In this chapter, we present a simple example of using the GNU tools in an AVR project. After reading this chapter, you should have a better feel as to how the tools are used and how a <code>Makefile</code> can be configured.</p>
<h1><a class="anchor" id="demo_project_desc"></a>
The Project</h1>
<p>This project will use pulse-width modulation (PWM) to ramp an LED on and off every two seconds. This project once used to start out with a simple homemade AVR circuit. Meanwhile, in particular the Arduino project has provided a large boost to the use of AVR microcontrollers, and Arduino compatible hardware is ubiquitous. We thus concentrate on something compatible to an Arduino Nano with an ATmega328P (or PB) MCU.</p>
<p>Alas, the only user LED on these Arduino devices is not attached to a GPIO pin that can be directly controlled by the timer hardware to generate the PWM signal. We thus toggle the LED in software.</p>
<p>The source code is given in <a class="el" href="group__demo__project.html#demo_project_src">demo.c</a>. For the sake of this example, create a file called <code>demo.c</code> containing this source code. Some of the more important parts of the code are:</p>
<dl class="section user"><dt>Note [1]:</dt><dd>It is always a good idea to avoid "magic numbers", and define macros for certain constants at the top of the project (or, in a separate header file). Note the use of the <code>_BV</code> macro: it turns a bit number into the respective bit mask.</dd></dl>
<dl class="section user"><dt>Note [2]:</dt><dd><a class="el" href="group__avr__interrupts.html#gad28590624d422cdf30d626e0a506255f">ISR()</a> is a macro that marks the function as an interrupt routine. In this case, the function will get called when timer 1 reaches its top value. Setting up interrupts is explained in greater detail in <a class="el" href="group__avr__interrupts.html">&lt;avr/interrupt.h&gt;: Interrupts</a>. <br  />
 As the 16-bit timer 1 is configured to run with a reduced 10 bit resolution, the top value is configured through the "input capture" register <code>ICP</code>, thus the input capture interrupt triggers when the timer reaches its top value.</dd></dl>
<dl class="section user"><dt>Note [3]:</dt><dd>Immediately at the start of the interrupt service, handle toggling the LED. As the Arduino Nano LED is attached from PB5 to GND, turn it on here. While the construct of reading the port register, ORing a bit mask into it, and writing it back might look cumbersome &ndash; the compiler will actually turn this into an <code>SBI</code> instruction by recognizing that the arguments to the operation are suitable for this optimization.</dd></dl>
<dl class="section user"><dt>Note [4]:</dt><dd>The PWM is being used in 10-bit mode, so we need a 16-bit variable to remember the current value.</dd></dl>
<dl class="section user"><dt>Note [5]:</dt><dd>This section determines the new value of the PWM.</dd></dl>
<dl class="section user"><dt>Note [6]:</dt><dd>Here's where the newly computed value is loaded into the compare register. Since we are in an interrupt routine, it is safe to use a 16-bit assignment to the register. Outside of an interrupt, the assignment should only be performed with interrupts disabled if there's a chance that an interrupt routine could also access this register (or another register that uses <code>TEMP</code>), see the appropriate <a class="el" href="FAQ.html#faq_16bitio">FAQ entry</a>.</dd></dl>
<dl class="section user"><dt>Note [7]:</dt><dd>This interrupt service routine gets called every time the counter reaches its compare/match value. Turn off the LED here.</dd></dl>
<dl class="section user"><dt>Note [8]:</dt><dd>This routine configures all the hardware after a reset.</dd></dl>
<dl class="section user"><dt>Note [9]:</dt><dd>The main loop of the program does nothing &ndash; all the work is done by the interrupt routines! The <code><a class="el" href="group__avr__sleep.html#ga3775b21f297187752bcfc434a541209a">sleep_mode()</a></code> puts the processor on sleep until the next interrupt, to conserve power. Of course, that probably won't be noticeable as we are still driving a LED, it is merely mentioned here to demonstrate the basic principle.</dd></dl>
<h1><a class="anchor" id="demo_project_src"></a>
The Source Code</h1>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * ----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):</span></div>
<div class="line"><span class="comment"> * &lt;joerg@FreeBSD.ORG&gt; wrote this file.  As long as you retain this notice you</span></div>
<div class="line"><span class="comment"> * can do whatever you want with this stuff. If we meet some day, and you think</span></div>
<div class="line"><span class="comment"> * this stuff is worth it, you can buy me a beer in return.        Joerg Wunsch</span></div>
<div class="line"><span class="comment"> * ----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Simple AVR demonstration.  Controls a LED that can be directly</span></div>
<div class="line"><span class="comment"> * connected from a pin to GND.  The brightness of the LED is</span></div>
<div class="line"><span class="comment"> * controlled with the PWM.  After each period of the PWM, the PWM</span></div>
<div class="line"><span class="comment"> * value is either incremented or decremented, that&#39;s all.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Configured to run on an Arduino Nano compatible device with an</span></div>
<div class="line"><span class="comment"> * ATmega328P.  The board has a LED, which is connected to PB5.  Since</span></div>
<div class="line"><span class="comment"> * PB5 is not a hardware waveform output from a timer on the</span></div>
<div class="line"><span class="comment"> * ATmega328P, the LED is toggled within the timer interrupts.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="stdint_8h.html">stdint.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">avr/io.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="interrupt_8h.html">avr/interrupt.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sleep_8h.html">avr/sleep.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Note [1] */</span></div>
<div class="line"><span class="preprocessor">#define TIMER1_TOP 1023</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define LED_PORT PORTB</span></div>
<div class="line"><span class="preprocessor">#define LED_DDR  DDRB</span></div>
<div class="line"><span class="preprocessor">#define LED_PIN  _BV(5)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">enum</span> { UP, DOWN };</div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="group__avr__interrupts.html#gad28590624d422cdf30d626e0a506255f">ISR</a>(TIMER1_CAPT_vect)           <span class="comment">// Note [2]</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// turn on LED</span></div>
<div class="line">    LED_PORT |= LED_PIN;        <span class="comment">// Note [3]</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_typedef" href="group__avr__stdint.html#ga1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> pwm;        <span class="comment">// Note [4]</span></div>
<div class="line">    <span class="keyword">static</span> <a class="code hl_typedef" href="group__avr__stdint.html#gaba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> direction;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (direction)          <span class="comment">// Note [5]</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> UP:</div>
<div class="line">            <span class="keywordflow">if</span> (++pwm == TIMER1_TOP)</div>
<div class="line">                direction = DOWN;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> DOWN:</div>
<div class="line">            <span class="keywordflow">if</span> (--pwm == 0)</div>
<div class="line">                direction = UP;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    OCR1A = pwm;                <span class="comment">// Note [6]</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="group__avr__interrupts.html#gad28590624d422cdf30d626e0a506255f">ISR</a>(TIMER1_COMPA_vect)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// turn off LED</span></div>
<div class="line">    LED_PORT &amp;= ~LED_PIN;       <span class="comment">// Note [7]</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">ioinit(<span class="keywordtype">void</span>)                    <span class="comment">// Note [8]</span></div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Timer 1 in CTC mode with 10 bits, CPU/8 speed */</span></div>
<div class="line">    ICR1 = TIMER1_TOP;</div>
<div class="line">    TCCR1A = 0;</div>
<div class="line">    TCCR1B = <a class="code hl_define" href="group__avr__sfr.html#ga11643f271076024c395a93800b3d9546">_BV</a>(WGM13) | <a class="code hl_define" href="group__avr__sfr.html#ga11643f271076024c395a93800b3d9546">_BV</a>(WGM12) | 2;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set PWM value to 0. */</span></div>
<div class="line">    OCR1A = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Enable OC1 as output. */</span></div>
<div class="line">    LED_DDR |= LED_PIN;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Enable timer 1 overflow and compare A interrupt. */</span></div>
<div class="line">    TIMSK1 = <a class="code hl_define" href="group__avr__sfr.html#ga11643f271076024c395a93800b3d9546">_BV</a>(ICIE1) | <a class="code hl_define" href="group__avr__sfr.html#ga11643f271076024c395a93800b3d9546">_BV</a>(OCIE1A);</div>
<div class="line">    <a class="code hl_define" href="group__avr__interrupts.html#gaad5ebd34cb344c26ac87594f79b06b73">sei</a> ();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    ioinit ();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Loop forever, the interrupts are doing the rest.  */</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (;;)                    <span class="comment">// Note [9]</span></div>
<div class="line">        <a class="code hl_function" href="group__avr__sleep.html#ga3775b21f297187752bcfc434a541209a">sleep_mode</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__avr__interrupts_html_gaad5ebd34cb344c26ac87594f79b06b73"><div class="ttname"><a href="group__avr__interrupts.html#gaad5ebd34cb344c26ac87594f79b06b73">sei</a></div><div class="ttdeci">#define sei()</div><div class="ttdef"><b>Definition:</b> interrupt.h:74</div></div>
<div class="ttc" id="agroup__avr__interrupts_html_gad28590624d422cdf30d626e0a506255f"><div class="ttname"><a href="group__avr__interrupts.html#gad28590624d422cdf30d626e0a506255f">ISR</a></div><div class="ttdeci">#define ISR(vector, attributes)</div><div class="ttdef"><b>Definition:</b> interrupt.h:118</div></div>
<div class="ttc" id="agroup__avr__sfr_html_ga11643f271076024c395a93800b3d9546"><div class="ttname"><a href="group__avr__sfr.html#ga11643f271076024c395a93800b3d9546">_BV</a></div><div class="ttdeci">#define _BV(bit)</div><div class="ttdef"><b>Definition:</b> sfr_defs.h:206</div></div>
<div class="ttc" id="agroup__avr__sleep_html_ga3775b21f297187752bcfc434a541209a"><div class="ttname"><a href="group__avr__sleep.html#ga3775b21f297187752bcfc434a541209a">sleep_mode</a></div><div class="ttdeci">void sleep_mode(void)</div></div>
<div class="ttc" id="agroup__avr__stdint_html_ga1f1825b69244eb3ad2c7165ddc99c956"><div class="ttname"><a href="group__avr__stdint.html#ga1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a></div><div class="ttdeci">unsigned int uint16_t</div><div class="ttdef"><b>Definition:</b> stdint.h:96</div></div>
<div class="ttc" id="agroup__avr__stdint_html_gaba7bc1797add20fe3efdf37ced1182c5"><div class="ttname"><a href="group__avr__stdint.html#gaba7bc1797add20fe3efdf37ced1182c5">uint8_t</a></div><div class="ttdeci">unsigned char uint8_t</div><div class="ttdef"><b>Definition:</b> stdint.h:88</div></div>
<div class="ttc" id="ainterrupt_8h_html"><div class="ttname"><a href="interrupt_8h.html">interrupt.h</a></div></div>
<div class="ttc" id="aio_8h_html"><div class="ttname"><a href="io_8h.html">io.h</a></div></div>
<div class="ttc" id="asleep_8h_html"><div class="ttname"><a href="sleep_8h.html">sleep.h</a></div></div>
<div class="ttc" id="astdint_8h_html"><div class="ttname"><a href="stdint_8h.html">stdint.h</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="demo_project_compile"></a>
Compiling and Linking</h1>
<p>This first thing that needs to be done is compile the source. When compiling, the compiler needs to know the processor type so the <code>-mmcu</code> option is specified. The <code>-Os</code> option will tell the compiler to optimize the code for efficient space usage (at the possible expense of code execution speed). The <code>-g</code> is used to embed debug info. The debug info is useful for disassemblies and doesn't end up in the <code>.hex</code> files, so I usually specify it. Finally, the <code>-c</code> tells the compiler to compile and stop &ndash; don't link. This demo is small enough that we could compile and link in one step. However, real-world projects will have several modules and will typically need to break up the building of the project into several compiles and one link.</p>
<pre class="fragment">$ avr-gcc -g -Os -mmcu=atmega328p -c demo.c
</pre><p>The compilation will create a <code>demo.o</code> file. Next we link it into a binary called <code>demo.elf</code>.</p>
<pre class="fragment">$ avr-gcc -g -mmcu=atmega328p -mrelax -o demo.elf demo.o
</pre><p>It is important to specify the MCU type when linking. The compiler uses the <code>-mmcu</code> option to choose start-up files and run-time libraries that get linked together. If this option isn't specified, the compiler defaults to the AT90S8515 processor environment, which is most certainly what you didn't want.</p>
<p>The <code>-mrelax</code> option instructs the linker to replace <code>CALL</code> instruction with faster and smaller <code>RCALL</code> instructions if possible.</p>
<h1><a class="anchor" id="demo_project_obj"></a>
Examining the Object File</h1>
<p><a id="a15_disassembling" name="a15_disassembling"></a></p>
<p>Now we have a binary file. Can we do anything useful with it (besides put it into the processor?) The GNU Binutils suite is made up of many useful tools for manipulating object files that get generated. One tool is <code>avr-objdump</code>, which takes information from the object file and displays it in many useful ways. Typing the command by itself will cause it to list out its options.</p>
<p>For instance, to get a feel of the application's size, the <code>-h</code> option can be used. The output of this option shows how much space is used in each of the output sections. The <code>.comment</code>, <code>.note</code> and <code>.debug</code> sections hold additional (debug) information and won't make it into the ROM file.</p>
<p>An overview of the program space and consumed by the program, and of the data in static storage, can be obtained with</p>
<pre class="fragment">$ avr-objdump -P mem-usage demo.elf
</pre><p>Since non-zero data in static storage consumes RAM, and also needs initialization values stored in non-volatile memory, the <code>.data</code> <a class="el" href="mem_sections.html#sec_ld_script">ouput section</a> contributes both to the text <a class="el" href="mem_sections.html#sec_memory_regions">segment</a> (called <em>Program</em> below) and also to the data segment (called <em>Data</em>). For our program, the output reads:</p>
<pre class="fragment">
demo.elf:     file format elf32-avr
AVR Memory Usage
----------------
Device: atmega328p

Program:     320 bytes (1.0% Full)
(.text + .data + .rodata + .bootloader)

Data:          3 bytes (0.1% Full)
(.data + .bss + .noinit)
</pre><p>An even more useful option is <code>-S</code>. This option disassembles the binary file and intersperses the source code in the output! Such a listing includes routines pulled in from the libraries and the vector table contents. Also, all the "fix-ups" have been satisfied. In other words, the listing generated by this option reflects the actual code that the processor will run.</p>
<pre class="fragment">$ avr-objdump -h -S demo.elf &gt; demo.lst
</pre><p>Here's the output as saved in the <code>demo.lst</code> file:</p>
<pre class="fragment">
demo.elf:     file format elf32-avr

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .data         00000000  00800100  00000140  000001d4  2**0
                  CONTENTS, ALLOC, LOAD, DATA
  1 .text         00000140  00000000  00000000  00000094  2**1
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  2 .bss          00000003  00800100  00800100  000001d4  2**0
                  ALLOC
  3 .comment      0000001a  00000000  00000000  000001d4  2**0
                  CONTENTS, READONLY
  4 .note.gnu.avr.deviceinfo 00000040  00000000  00000000  000001f0  2**2
                  CONTENTS, READONLY, OCTETS
  5 .debug_aranges 00000068  00000000  00000000  00000230  2**3
                  CONTENTS, READONLY, DEBUGGING, OCTETS
  6 .debug_info   00000760  00000000  00000000  00000298  2**0
                  CONTENTS, READONLY, DEBUGGING, OCTETS
  7 .debug_abbrev 000006c3  00000000  00000000  000009f8  2**0
                  CONTENTS, READONLY, DEBUGGING, OCTETS
  8 .debug_line   00000388  00000000  00000000  000010bb  2**0
                  CONTENTS, READONLY, DEBUGGING, OCTETS
  9 .debug_frame  00000050  00000000  00000000  00001444  2**2
                  CONTENTS, READONLY, DEBUGGING, OCTETS
 10 .debug_str    0000038f  00000000  00000000  00001494  2**0
                  CONTENTS, READONLY, DEBUGGING, OCTETS
 11 .debug_ranges 00000018  00000000  00000000  00001823  2**0
                  CONTENTS, READONLY, DEBUGGING, OCTETS

Disassembly of section .text:

00000000 &lt;__vectors&gt;:
   0:	33 c0       	rjmp	.+102    	; 0x68 &lt;__ctors_end&gt;
   2:	00 00       	nop
   4:	7a c0       	rjmp	.+244    	; 0xfa &lt;__bad_interrupt&gt;
   6:	00 00       	nop
   8:	78 c0       	rjmp	.+240    	; 0xfa &lt;__bad_interrupt&gt;
   a:	00 00       	nop
   c:	76 c0       	rjmp	.+236    	; 0xfa &lt;__bad_interrupt&gt;
   e:	00 00       	nop
  10:	74 c0       	rjmp	.+232    	; 0xfa &lt;__bad_interrupt&gt;
  12:	00 00       	nop
  14:	72 c0       	rjmp	.+228    	; 0xfa &lt;__bad_interrupt&gt;
  16:	00 00       	nop
  18:	70 c0       	rjmp	.+224    	; 0xfa &lt;__bad_interrupt&gt;
  1a:	00 00       	nop
  1c:	6e c0       	rjmp	.+220    	; 0xfa &lt;__bad_interrupt&gt;
  1e:	00 00       	nop
  20:	6c c0       	rjmp	.+216    	; 0xfa &lt;__bad_interrupt&gt;
  22:	00 00       	nop
  24:	6a c0       	rjmp	.+212    	; 0xfa &lt;__bad_interrupt&gt;
  26:	00 00       	nop
  28:	2f c0       	rjmp	.+94     	; 0x88 &lt;__vector_10&gt;
  2a:	00 00       	nop
  2c:	64 c0       	rjmp	.+200    	; 0xf6 &lt;__vector_11&gt;
  2e:	00 00       	nop
  30:	64 c0       	rjmp	.+200    	; 0xfa &lt;__bad_interrupt&gt;
  32:	00 00       	nop
  34:	62 c0       	rjmp	.+196    	; 0xfa &lt;__bad_interrupt&gt;
  36:	00 00       	nop
  38:	60 c0       	rjmp	.+192    	; 0xfa &lt;__bad_interrupt&gt;
  3a:	00 00       	nop
  3c:	5e c0       	rjmp	.+188    	; 0xfa &lt;__bad_interrupt&gt;
  3e:	00 00       	nop
  40:	5c c0       	rjmp	.+184    	; 0xfa &lt;__bad_interrupt&gt;
  42:	00 00       	nop
  44:	5a c0       	rjmp	.+180    	; 0xfa &lt;__bad_interrupt&gt;
  46:	00 00       	nop
  48:	58 c0       	rjmp	.+176    	; 0xfa &lt;__bad_interrupt&gt;
  4a:	00 00       	nop
  4c:	56 c0       	rjmp	.+172    	; 0xfa &lt;__bad_interrupt&gt;
  4e:	00 00       	nop
  50:	54 c0       	rjmp	.+168    	; 0xfa &lt;__bad_interrupt&gt;
  52:	00 00       	nop
  54:	52 c0       	rjmp	.+164    	; 0xfa &lt;__bad_interrupt&gt;
  56:	00 00       	nop
  58:	50 c0       	rjmp	.+160    	; 0xfa &lt;__bad_interrupt&gt;
  5a:	00 00       	nop
  5c:	4e c0       	rjmp	.+156    	; 0xfa &lt;__bad_interrupt&gt;
  5e:	00 00       	nop
  60:	4c c0       	rjmp	.+152    	; 0xfa &lt;__bad_interrupt&gt;
  62:	00 00       	nop
  64:	4a c0       	rjmp	.+148    	; 0xfa &lt;__bad_interrupt&gt;
	...

00000068 &lt;__ctors_end&gt;:
  68:	11 24       	eor	r1, r1
  6a:	1f be       	out	0x3f, r1	; 63

0000006c &lt;__init_sp&gt;:
  6c:	cf ef       	ldi	r28, 0xFF	; 255
  6e:	d8 e0       	ldi	r29, 0x08	; 8
  70:	de bf       	out	0x3e, r29	; 62
  72:	cd bf       	out	0x3d, r28	; 61

00000074 &lt;__do_clear_bss&gt;:
/* __do_clear_bss is only necessary if there is anything in .bss section.  */

#ifdef L_clear_bss
	.section .init4,"ax",@progbits
DEFUN __do_clear_bss
	ldi	r18, hi8(__bss_end)
  74:	21 e0       	ldi	r18, 0x01	; 1

00000076 &lt;.Loc.1&gt;:
	ldi	r26, lo8(__bss_start)
  76:	a0 e0       	ldi	r26, 0x00	; 0

00000078 &lt;.Loc.2&gt;:
	ldi	r27, hi8(__bss_start)
  78:	b1 e0       	ldi	r27, 0x01	; 1

0000007a &lt;.Loc.3&gt;:
	rjmp	.do_clear_bss_start
  7a:	01 c0       	rjmp	.+2      	; 0x7e &lt;.Loc.5&gt;

0000007c &lt;.Loc.4&gt;:
.do_clear_bss_loop:
	st	X+, __zero_reg__
  7c:	1d 92       	st	X+, r1

0000007e &lt;.Loc.5&gt;:
.do_clear_bss_start:
	cpi	r26, lo8(__bss_end)
  7e:	a3 30       	cpi	r26, 0x03	; 3

00000080 &lt;.Loc.6&gt;:
	cpc	r27, r18
  80:	b2 07       	cpc	r27, r18

00000082 &lt;.Loc.7&gt;:
	brne	.do_clear_bss_loop
  82:	e1 f7       	brne	.-8      	; 0x7c &lt;.Loc.4&gt;

00000084 &lt;__call_main&gt;:
  84:	3b d0       	rcall	.+118    	; 0xfc &lt;main&gt;
  86:	58 c0       	rjmp	.+176    	; 0x138 &lt;exit&gt;

00000088 &lt;__vector_10&gt;:
#define LED_PIN  _BV(5)

enum { UP, DOWN };

ISR(TIMER1_CAPT_vect)           // Note [2]
{
  88:	1f 92       	push	r1
  8a:	1f b6       	in	r1, 0x3f	; 63
  8c:	1f 92       	push	r1
  8e:	11 24       	eor	r1, r1
  90:	2f 93       	push	r18
  92:	8f 93       	push	r24
  94:	9f 93       	push	r25

00000096 &lt;.Loc.1&gt;:
    // turn on LED
    LED_PORT |= LED_PIN;        // Note [3]
  96:	2d 9a       	sbi	0x05, 5	; 5

00000098 &lt;.Loc.3&gt;:

    static uint16_t pwm;        // Note [4]
    static uint8_t direction;

    switch (direction)          // Note [5]
  98:	20 91 02 01 	lds	r18, 0x0102	; 0x800102 &lt;direction.1561&gt;
  9c:	80 91 00 01 	lds	r24, 0x0100	; 0x800100 &lt;pwm.1560&gt;
  a0:	90 91 01 01 	lds	r25, 0x0101	; 0x800101 &lt;pwm.1560+0x1&gt;
  a4:	22 23       	and	r18, r18
  a6:	89 f0       	breq	.+34     	; 0xca &lt;.L2&gt;
  a8:	21 30       	cpi	r18, 0x01	; 1
  aa:	d9 f0       	breq	.+54     	; 0xe2 &lt;.L3&gt;

000000ac &lt;.L4&gt;:
            if (--pwm == 0)
                direction = UP;
            break;
    }

    OCR1A = pwm;                // Note [6]
  ac:	80 91 00 01 	lds	r24, 0x0100	; 0x800100 &lt;pwm.1560&gt;
  b0:	90 91 01 01 	lds	r25, 0x0101	; 0x800101 &lt;pwm.1560+0x1&gt;
  b4:	90 93 89 00 	sts	0x0089, r25	; 0x800089 &lt;__TEXT_REGION_LENGTH__+0x7f8089&gt;
  b8:	80 93 88 00 	sts	0x0088, r24	; 0x800088 &lt;__TEXT_REGION_LENGTH__+0x7f8088&gt;

000000bc &lt;.Loc.8&gt;:
}
  bc:	9f 91       	pop	r25
  be:	8f 91       	pop	r24
  c0:	2f 91       	pop	r18
  c2:	1f 90       	pop	r1
  c4:	1f be       	out	0x3f, r1	; 63
  c6:	1f 90       	pop	r1
  c8:	18 95       	reti

000000ca &lt;.L2&gt;:
            if (++pwm == TIMER1_TOP)
  ca:	01 96       	adiw	r24, 0x01	; 1

000000cc &lt;.Loc.11&gt;:
  cc:	90 93 01 01 	sts	0x0101, r25	; 0x800101 &lt;pwm.1560+0x1&gt;
  d0:	80 93 00 01 	sts	0x0100, r24	; 0x800100 &lt;pwm.1560&gt;
  d4:	8f 3f       	cpi	r24, 0xFF	; 255
  d6:	93 40       	sbci	r25, 0x03	; 3
  d8:	49 f7       	brne	.-46     	; 0xac &lt;.L4&gt;

000000da &lt;.Loc.12&gt;:
                direction = DOWN;
  da:	81 e0       	ldi	r24, 0x01	; 1
  dc:	80 93 02 01 	sts	0x0102, r24	; 0x800102 &lt;direction.1561&gt;
  e0:	e5 cf       	rjmp	.-54     	; 0xac &lt;.L4&gt;

000000e2 &lt;.L3&gt;:
            if (--pwm == 0)
  e2:	01 97       	sbiw	r24, 0x01	; 1

000000e4 &lt;.Loc.16&gt;:
  e4:	90 93 01 01 	sts	0x0101, r25	; 0x800101 &lt;pwm.1560+0x1&gt;
  e8:	80 93 00 01 	sts	0x0100, r24	; 0x800100 &lt;pwm.1560&gt;
  ec:	89 2b       	or	r24, r25
  ee:	f1 f6       	brne	.-68     	; 0xac &lt;.L4&gt;

000000f0 &lt;.Loc.17&gt;:
                direction = UP;
  f0:	10 92 02 01 	sts	0x0102, r1	; 0x800102 &lt;direction.1561&gt;
  f4:	db cf       	rjmp	.-74     	; 0xac &lt;.L4&gt;

000000f6 &lt;__vector_11&gt;:

ISR(TIMER1_COMPA_vect)
{
    // turn off LED
    LED_PORT &amp;= ~LED_PIN;       // Note [7]
  f6:	2d 98       	cbi	0x05, 5	; 5

000000f8 &lt;.Loc.22&gt;:
}
  f8:	18 95       	reti

000000fa &lt;__bad_interrupt&gt;:
  fa:	82 cf       	rjmp	.-252    	; 0x0 &lt;__vectors&gt;

000000fc &lt;main&gt;:

static void
ioinit(void)                    // Note [8]
{
    /* Timer 1 in CTC mode with 10 bits, CPU/8 speed */
    ICR1 = TIMER1_TOP;
  fc:	8f ef       	ldi	r24, 0xFF	; 255
  fe:	93 e0       	ldi	r25, 0x03	; 3
 100:	90 93 87 00 	sts	0x0087, r25	; 0x800087 &lt;__TEXT_REGION_LENGTH__+0x7f8087&gt;
 104:	80 93 86 00 	sts	0x0086, r24	; 0x800086 &lt;__TEXT_REGION_LENGTH__+0x7f8086&gt;

00000108 &lt;.Loc.28&gt;:
    TCCR1A = 0;
 108:	10 92 80 00 	sts	0x0080, r1	; 0x800080 &lt;__TEXT_REGION_LENGTH__+0x7f8080&gt;

0000010c &lt;.Loc.30&gt;:
    TCCR1B = _BV(WGM13) | _BV(WGM12) | 2;
 10c:	8a e1       	ldi	r24, 0x1A	; 26
 10e:	80 93 81 00 	sts	0x0081, r24	; 0x800081 &lt;__TEXT_REGION_LENGTH__+0x7f8081&gt;

00000112 &lt;.Loc.32&gt;:

    /* Set PWM value to 0. */
    OCR1A = 1;
 112:	81 e0       	ldi	r24, 0x01	; 1
 114:	90 e0       	ldi	r25, 0x00	; 0
 116:	90 93 89 00 	sts	0x0089, r25	; 0x800089 &lt;__TEXT_REGION_LENGTH__+0x7f8089&gt;
 11a:	80 93 88 00 	sts	0x0088, r24	; 0x800088 &lt;__TEXT_REGION_LENGTH__+0x7f8088&gt;

0000011e &lt;.Loc.34&gt;:

    /* Enable OC1 as output. */
    LED_DDR |= LED_PIN;
 11e:	25 9a       	sbi	0x04, 5	; 4

00000120 &lt;.Loc.36&gt;:

    /* Enable timer 1 overflow and compare A interrupt. */
    TIMSK1 = _BV(ICIE1) | _BV(OCIE1A);
 120:	82 e2       	ldi	r24, 0x22	; 34
 122:	80 93 6f 00 	sts	0x006F, r24	; 0x80006f &lt;__TEXT_REGION_LENGTH__+0x7f806f&gt;

00000126 &lt;.Loc.38&gt;:
    sei ();
 126:	78 94       	sei

00000128 &lt;.L9&gt;:
    ioinit ();

    /* Loop forever, the interrupts are doing the rest.  */

    for (;;)                    // Note [9]
        sleep_mode();
 128:	83 b7       	in	r24, 0x33	; 51
 12a:	81 60       	ori	r24, 0x01	; 1
 12c:	83 bf       	out	0x33, r24	; 51

0000012e &lt;.Loc.43&gt;:
 12e:	88 95       	sleep

00000130 &lt;.Loc.46&gt;:
 130:	83 b7       	in	r24, 0x33	; 51
 132:	8e 7f       	andi	r24, 0xFE	; 254
 134:	83 bf       	out	0x33, r24	; 51

00000136 &lt;.Loc.49&gt;:
    for (;;)                    // Note [9]
 136:	f8 cf       	rjmp	.-16     	; 0x128 &lt;.L9&gt;

00000138 &lt;exit&gt;:
 138:	f8 94       	cli
 13a:	00 c0       	rjmp	.+0      	; 0x13c &lt;_exit&gt;

0000013c &lt;_exit&gt;:
	cli
 13c:	f8 94       	cli

0000013e &lt;__stop_program&gt;:
	rjmp	__stop_program
 13e:	ff cf       	rjmp	.-2      	; 0x13e &lt;__stop_program&gt;
</pre><h1><a class="anchor" id="demo_project_map"></a>
Linker Map Files</h1>
<p><code>avr-objdump</code> is very useful, but sometimes it's necessary to see information about the link that can only be generated by the linker. A map file contains this information. A map file is useful for monitoring the sizes of your code and data. It also shows where modules are loaded and which modules were loaded from libraries. It is yet another view of your application. To get a map file, I usually add <code><b>-Wl,-Map,demo.map</b></code> to my link command. Relink the application using the following command to generate <code>demo.map</code> (a portion of which is shown below). The linker will create a map file even in the case when some memory region overflows and the linker fails with an error. So you can collect valuable information about the cause of the overflow.</p>
<pre class="fragment">$ avr-gcc -g -mmcu=atmega328p -Wl,-Map,demo.map -mrelax -o demo.elf demo.o
</pre><p></p>
<p>Some points of interest in the <code>demo.map</code> file are:</p>
<div class="fragment"><div class="line">.rela.plt</div>
<div class="line"> *(.rela.plt)</div>
<div class="line"> </div>
<div class="line">.text           0x00000000      0x140</div>
<div class="line"> *(.vectors)</div>
<div class="line"> .vectors       0x00000000       0x68 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/crtatmega328p.o</div>
<div class="line">                0x00000000                __vectors</div>
<div class="line">                0x00000000                __vector_default</div>
<div class="line"> *(.vectors)</div>
<div class="line"> *(.progmem.gcc*)</div>
<div class="line">                0x00000068                        . = ALIGN (0x2)</div>
<div class="line">                0x00000068                        __trampolines_start = .</div>
<div class="line"> *(.trampolines)</div>
<div class="line"> .trampolines   0x00000068        0x0 linker stubs</div>
<div class="line"> *(.trampolines*)</div>
<div class="line">                0x00000068                        __trampolines_end = .</div>
<div class="line"> *libprintf_flt.a:*(.progmem.data)</div>
<div class="line"> *libc.a:*(.progmem.data)</div>
<div class="line"> *(.progmem.*)</div>
<div class="line">                0x00000068                        . = ALIGN (0x2)</div>
<div class="line"> *(.lowtext)</div>
<div class="line"> *(.lowtext*)</div>
<div class="line">                0x00000068                        __ctors_start = .</div>
</div><!-- fragment --><p> The <a class="el" href="mem_sections.html#sec_dot_text"><code>.text</code> segment</a> (where program instructions are stored) starts at location 0x0 and occupies  0x140 = 320
  bytes.  0x68 = 104
  bytes of that are allocated to interrupt vectors in <code>.vectors</code>, which is basically defined by the MCU hardware.</p>
<div class="fragment"><div class="line"> *(.fini2)</div>
<div class="line"> *(.fini2)</div>
<div class="line"> *(.fini1)</div>
<div class="line"> *(.fini1)</div>
<div class="line"> *(.fini0)</div>
<div class="line"> .fini0         0x0000013c        0x4 /home/DATA/gnu/install/gcc-8.5-avr/bin/../lib/gcc/avr/8.5.1/avr5/libgcc.a(_exit.o)</div>
<div class="line"> *(.fini0)</div>
<div class="line"> *(.hightext)</div>
<div class="line"> *(.hightext*)</div>
<div class="line"> *(.progmemx.*)</div>
<div class="line">                0x00000140                        . = ALIGN (0x2)</div>
<div class="line"> *(.jumptables)</div>
<div class="line"> *(.jumptables*)</div>
<div class="line">                0x00000140                        _etext = .</div>
<div class="line"> </div>
<div class="line">.data           0x00800100        0x0 load address 0x00000140</div>
<div class="line">                [!provide]                        PROVIDE (__data_start = .)</div>
<div class="line"> *(.data)</div>
<div class="line"> .data          0x00800100        0x0 demo.o</div>
<div class="line"> .data          0x00800100        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/crtatmega328p.o</div>
<div class="line"> .data          0x00800100        0x0 /home/DATA/gnu/install/gcc-8.5-avr/bin/../lib/gcc/avr/8.5.1/avr5/libgcc.a(_clear_bss.o)</div>
<div class="line"> .data          0x00800100        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/libatmega328p.a(init_sp.o)</div>
<div class="line"> .data          0x00800100        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/libatmega328p.a(call_main.o)</div>
<div class="line"> .data          0x00800100        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/lib/avr5/libc.a(exit.o)</div>
<div class="line"> .data          0x00800100        0x0 /home/DATA/gnu/install/gcc-8.5-avr/bin/../lib/gcc/avr/8.5.1/avr5/libgcc.a(_exit.o)</div>
<div class="line"> *(.data*)</div>
<div class="line"> *(.gnu.linkonce.d*)</div>
<div class="line"> *(.rodata)</div>
<div class="line"> *(.rodata*)</div>
<div class="line"> *(.gnu.linkonce.r*)</div>
<div class="line">                0x00800100                        . = ALIGN (0x2)</div>
<div class="line">                0x00800100                        _edata = .</div>
<div class="line">                [!provide]                        PROVIDE (__data_end = .)</div>
<div class="line"> </div>
<div class="line">.bss            0x00800100        0x3</div>
<div class="line">                0x00800100                        PROVIDE (__bss_start = .)</div>
<div class="line"> *(.bss)</div>
<div class="line"> .bss           0x00800100        0x3 demo.o</div>
<div class="line"> .bss           0x00800103        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/crtatmega328p.o</div>
<div class="line"> .bss           0x00800103        0x0 /home/DATA/gnu/install/gcc-8.5-avr/bin/../lib/gcc/avr/8.5.1/avr5/libgcc.a(_clear_bss.o)</div>
<div class="line"> .bss           0x00800103        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/libatmega328p.a(init_sp.o)</div>
<div class="line"> .bss           0x00800103        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/devices/atmega328p/libatmega328p.a(call_main.o)</div>
<div class="line"> .bss           0x00800103        0x0 /home/john/gnu/build/avr-libc-onlinedocs/avr/lib/avr5/libc.a(exit.o)</div>
<div class="line"> .bss           0x00800103        0x0 /home/DATA/gnu/install/gcc-8.5-avr/bin/../lib/gcc/avr/8.5.1/avr5/libgcc.a(_exit.o)</div>
<div class="line"> *(.bss*)</div>
<div class="line"> *(COMMON)</div>
<div class="line">                0x00800103                        PROVIDE (__bss_end = .)</div>
<div class="line">                0x00000140                        __data_load_start = LOADADDR (.data)</div>
<div class="line">                0x00000140                        __data_load_end = (__data_load_start + SIZEOF (.data))</div>
<div class="line"> </div>
<div class="line">.noinit         0x00800103        0x0</div>
<div class="line">                [!provide]                        PROVIDE (__noinit_start = .)</div>
<div class="line"> *(.noinit .noinit.* .gnu.linkonce.n.*)</div>
<div class="line">                [!provide]                        PROVIDE (__noinit_end = .)</div>
<div class="line">                0x00800103                        _end = .</div>
<div class="line">                [!provide]                        PROVIDE (__heap_start = .)</div>
<div class="line">                0x00000000                        __flmap_init_label = DEFINED (__flmap_noinit_start)?__flmap_noinit_start:0x0</div>
<div class="line">                0x00000000                        __flmap = DEFINED (__flmap)?__flmap:0x0</div>
<div class="line"> </div>
<div class="line">.eeprom         0x00810000        0x0</div>
<div class="line"> *(.eeprom*)</div>
<div class="line">                0x00810000                        __eeprom_end = .</div>
</div><!-- fragment --><p> The address one byte past the last address in the <code>.text</code> segment is denoted by <code>_etext</code>.</p>
<p>The <code>.data</code> segment (where initialized static variables are stored) starts at location 0x100, which is the first address after the IO registers on an ATmega328P processor. The segment is mapped to 0x800000 to simulate a flat address space.</p>
<p>The next available address in the <code>.data</code> segment is also location 0x100, so the application has no non-zero initialized data.</p>
<p>The <code>.bss</code> segment (where <a class="el" href="FAQ.html#faq_varinit">zero-initialized data</a> is stored) starts at location 0x100.</p>
<p>The next available address in the <code>.bss</code> segment is location 0x103, so the application uses a total of 3 bytes of zero-initialized data, all from the <code>demo.o</code> module. These are the <code>pwm</code> (2 bytes) and <code>direction</code> (1 byte) static variables of the <code>TIMER1_CAPT_vect</code> ISR.</p>
<p>The range from <code>__data_load_start</code> to <code>__data_load_end</code> holds the initialization data for the <code>.data</code> segment, which is read by the <a class="el" href="mem_sections.html#sec_dot_init">startup code</a> to initialize <code>.data</code> before main() starts. As the two symbols have the same value, there is nothing to copy to <code>.data</code> (since there are no variables in the <code>.data</code> input sections).</p>
<p>The <code>.eeprom</code> segment (where EEPROM variables are stored) starts at location 0x0, mapped to 0x810000 to simulate a flat address space.</p>
<p>The next available address in the <code>.eeprom</code> segment is also location 0x0, so there aren't any EEPROM variables.</p>
<h1><a class="anchor" id="demo_ihex"></a>
Generating Intel Hex Files</h1>
<p>We have a binary of the application, but how do we get it into the processor?</p>
<p>Many programming applications like AVRDUDE now accept the final ELF file as input, so no further step is needed there.</p>
<p>Some programmers require a specific kind of load file, like "Intel
Hex" or "Motorola SRecord" format. For them, portions of the binary need to be extracted. The GNU utility that does this is called <code>avr-objcopy</code>.</p>
<p>The ROM contents can be pulled from our project's binary and put into the file demo.hex using the following command:</p>
<pre class="fragment">$ avr-objcopy -j .text -j .data -O ihex demo.elf demo.hex
</pre><p>The <code>-j</code> option indicates that we want the information from the <code>.text</code> and <code>.data</code> segment extracted. Note that the <code><a class="el" href="mem_sections.html#sec_dot_data">.data</a></code> segment must be included as it contains the initialization values for the data segment, which the startup code expects to be placed immediately behind the instruction code (the <code><a class="el" href="mem_sections.html#sec_dot_text">.text</a></code> segment) in flash. The <a class="el" href="mem_sections.html#sec_dot_init">startup code</a> then copies them over to RAM before calling <code>main()</code>.</p>
<p>On devices with a <code><a class="el" href="mem_sections.html#sec_dot_rodata">.rodata</a></code> segment, <code>-j .rodata</code> must be added to the options. (The ATmega328P doesn't have a <code>.rodata</code> segment since its <code>.rodata</code> input sections are allocated to the <code>.data</code> segment. See the <a class="el" href="FAQ.html#faq_flashstrings">FAQ</a> for an explanation.)</p>
<p>The resulting <code>demo.hex</code> file contains:</p>
<pre class="fragment">:1000000033C000007AC0000078C0000076C0000055
:1000100074C0000072C0000070C000006EC000001C
:100020006CC000006AC000002FC0000064C0000067
:1000300064C0000062C0000060C000005EC000003C
:100040005CC000005AC0000058C0000056C000004C
:1000500054C0000052C0000050C000004EC000005C
:100060004CC000004AC0000011241FBECFEFD8E0F2
:10007000DEBFCDBF21E0A0E0B1E001C01D92A33002
:10008000B207E1F73BD058C01F921FB61F92112450
:100090002F938F939F932D9A2091020180910001BD
:1000A00090910101222389F02130D9F08091000143
:1000B0009091010190938900809388009F918F9186
:1000C0002F911F901FBE1F901895019690930101CC
:1000D000809300018F3F934049F781E080930201B4
:1000E000E5CF01979093010180930001892BF1F6F0
:1000F00010920201DBCF2D98189582CF8FEF93E0FD
:100100009093870080938600109280008AE180930C
:10011000810081E090E09093890080938800259A87
:1001200082E280936F00789483B7816083BF889563
:1001300083B78E7F83BFF8CFF89400C0F894FFCFC9
:00000001FF
</pre><p>If we specify the EEPROM segment, we can generate a <code>.hex</code> file that can be used to program the EEPROM:</p>
<pre class="fragment">$ avr-objcopy -j .eeprom --change-section-lma .eeprom=0 -O ihex demo.elf demo_eeprom.hex
</pre><p>There is no <code>demo_eeprom.hex</code> file written, as that file would be empty.</p>
<h1><a class="anchor" id="demo_make"></a>
Letting Make Build the Project</h1>
<p>Rather than type these commands over and over, they can all be placed in a make file. To build the demo project using GNU make, save the following in a file called <code>Makefile</code>.</p>
<p>This also adds a "program" target, so in order to download the image to the device's flash, it can simply called as</p>
<pre class="fragment">$ make program
</pre><p>The actual port (serial device) to talk to when programming can be specified in the environment variable <code>AVRDUDE_PORT</code>. There is some guesswork about possible ports (OS dependant) inside the Makefile if this variable does not exist.</p>
<dl class="section note"><dt>Note</dt><dd>This <code>Makefile</code> can only be used as input for the GNU version of <code>make</code>.</dd></dl>
<div class="fragment"><div class="line">PRG            = demo</div>
<div class="line">OBJ            = demo.o</div>
<div class="line"> </div>
<div class="line">MCU_TARGET     = atmega328p</div>
<div class="line"> </div>
<div class="line">OPTIMIZE = -Os</div>
<div class="line"> </div>
<div class="line">WARN = -Wall -Wextra -Werror=missing-prototypes -Werror=strict-prototypes</div>
<div class="line"> </div>
<div class="line">DEFS =</div>
<div class="line">LIBS =</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># AVRDUDE configuration</span></div>
<div class="line"><span class="preprocessor"># override that from the environment if needed</span></div>
<div class="line">ifndef AVRDUDE_PORT</div>
<div class="line">  ifeq ($(OS),Windows_NT)</div>
<div class="line">    AVRDUDE_PORT = COM3</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    UNAME_S := $(shell uname -s)</div>
<div class="line">    ifeq ($(UNAME_S),Linux)</div>
<div class="line">        AVRDUDE_PORT = /dev/ttyUSB0</div>
<div class="line">    endif</div>
<div class="line">    ifeq ($(UNAME_S),Darwin)</div>
<div class="line">        AVRDUDE_PORT = /dev/cu.usbserial-10</div>
<div class="line">    endif</div>
<div class="line">    ifeq ($(UNAME_S),FreeBSD)</div>
<div class="line">        AVRDUDE_PORT = /dev/cuaU0</div>
<div class="line">    endif</div>
<div class="line">  endif</div>
<div class="line">endif</div>
<div class="line">ifndef AVRDUDE_PROGRAMMER</div>
<div class="line">  AVRDUDE_PROGRAMMER = arduino</div>
<div class="line">endif</div>
<div class="line">ifndef AVRDUDE_ADDITIONAL</div>
<div class="line">  AVRDUDE_ADDITIONAL = -b 57600 # <span class="keywordflow">for</span> Arduino Nano compat device</div>
<div class="line">endif</div>
<div class="line">ifndef AVRDUDE</div>
<div class="line">  AVRDUDE = avrdude # search along $PATH</div>
<div class="line">endif</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># You should not have to change anything below here.</span></div>
<div class="line"> </div>
<div class="line">CC      = avr-gcc</div>
<div class="line"> </div>
<div class="line">CFLAGS  = -g $(WARN) $(OPTIMIZE) -mmcu=$(MCU_TARGET) $(DEFS)</div>
<div class="line">LDFLAGS = -Wl,-Map,$(PRG).map -mrelax</div>
<div class="line"> </div>
<div class="line">OBJCOPY = avr-objcopy</div>
<div class="line">OBJDUMP = avr-objdump</div>
<div class="line"> </div>
<div class="line">all: $(PRG).elf lst text eeprom</div>
<div class="line"> </div>
<div class="line">$(PRG).elf: $(OBJ)</div>
<div class="line">    $(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ $(LIBS)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># dependency:</span></div>
<div class="line">demo.o: demo.c</div>
<div class="line"> </div>
<div class="line">clean:</div>
<div class="line">    rm -f -- *.o $(PRG).elf</div>
<div class="line">    rm -f -- *.lst *.map $(EXTRA_CLEAN_FILES)</div>
<div class="line"> </div>
<div class="line">lst:  $(PRG).lst</div>
<div class="line"> </div>
<div class="line">%.lst: %.elf</div>
<div class="line">    $(OBJDUMP) -h -S $&lt; &gt; $@</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># device programming</span></div>
<div class="line"> </div>
<div class="line">program: $(PRG).elf</div>
<div class="line">    $(AVRDUDE) -c $(AVRDUDE_PROGRAMMER) \</div>
<div class="line">      -p $(MCU_TARGET) -P $(AVRDUDE_PORT) \</div>
<div class="line">      $(AVRDUDE_ADDITIONAL) \</div>
<div class="line">      -U $(PRG).elf</div>
<div class="line"> </div>
<div class="line">.PHONY: all clean lst program</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Rules for building the .text rom images</span></div>
<div class="line"> </div>
<div class="line">text: hex bin srec</div>
<div class="line"> </div>
<div class="line">hex:  $(PRG).hex</div>
<div class="line">bin:  $(PRG).bin</div>
<div class="line">srec: $(PRG).srec</div>
<div class="line"> </div>
<div class="line">%.hex: %.elf</div>
<div class="line">    $(OBJCOPY) -j .text -j .data -O ihex $&lt; $@</div>
<div class="line"> </div>
<div class="line">%.srec: %.elf</div>
<div class="line">    $(OBJCOPY) -j .text -j .data -O srec $&lt; $@</div>
<div class="line"> </div>
<div class="line">%.bin: %.elf</div>
<div class="line">    $(OBJCOPY) -j .text -j .data -O binary $&lt; $@</div>
<div class="line"> </div>
<div class="line">.PHONY: text hex bin srec</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Rules for building the .eeprom rom images</span></div>
<div class="line"> </div>
<div class="line">eeprom: ehex ebin esrec</div>
<div class="line"> </div>
<div class="line">ehex:  $(PRG)_eeprom.hex</div>
<div class="line">ebin:  $(PRG)_eeprom.bin</div>
<div class="line">esrec: $(PRG)_eeprom.srec</div>
<div class="line"> </div>
<div class="line">%_eeprom.hex: %.elf</div>
<div class="line">    $(OBJCOPY) -j .eeprom --change-section-lma .eeprom=0 -O ihex $&lt; $@ \</div>
<div class="line">    || { echo empty $@ not generated; <a class="code hl_function" href="group__avr__stdlib.html#ga037e1211798125c945a26bfbfdf26b8f">exit</a> 0; }</div>
<div class="line"> </div>
<div class="line">%_eeprom.srec: %.elf</div>
<div class="line">    $(OBJCOPY) -j .eeprom --change-section-lma .eeprom=0 -O srec $&lt; $@ \</div>
<div class="line">    || { echo empty $@ not generated; <a class="code hl_function" href="group__avr__stdlib.html#ga037e1211798125c945a26bfbfdf26b8f">exit</a> 0; }</div>
<div class="line"> </div>
<div class="line">%_eeprom.bin: %.elf</div>
<div class="line">    $(OBJCOPY) -j .eeprom --change-section-lma .eeprom=0 -O binary $&lt; $@ \</div>
<div class="line">    || { echo empty $@ not generated; <a class="code hl_function" href="group__avr__stdlib.html#ga037e1211798125c945a26bfbfdf26b8f">exit</a> 0; }</div>
<div class="line"> </div>
<div class="line">EXTRA_CLEAN_FILES += *.hex *.bin *.srec</div>
<div class="line"> </div>
<div class="line">.PHONY: eeprom ehex ebin esrec</div>
<div class="ttc" id="agroup__avr__stdlib_html_ga037e1211798125c945a26bfbfdf26b8f"><div class="ttname"><a href="group__avr__stdlib.html#ga037e1211798125c945a26bfbfdf26b8f">exit</a></div><div class="ttdeci">void exit(int __status)</div></div>
</div><!-- fragment --> <h1><a class="anchor" id="demo_sourceref"></a>
Reference to the source code</h1>
<p> 
<ul>
  <li><a href="examples/demo/demo.c">demo.c</a></li>
  <li><a href="examples/demo/Makefile">Makefile</a></li>
</ul>
</p>
<p> </p>
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Dec 28 2025 13:38:39 for AVR-LibC by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.9.6
</small></address>
</body>
</html>
