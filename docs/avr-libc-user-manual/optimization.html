<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<title>AVR-LibC: Compiler optimization</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dox.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AVR-LibC
   &#160;<span id="projectnumber">2.2.0</span>
   </div>
   <div id="projectbrief">Standard C library for AVR-GCC</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table>
  <tr>
    <td align="left"><a href="https://avrdudes.github.io/avr-libc/"><h2>AVR-LibC Documentation</h2></a></td>
    <td align="center" colspan=4><img src="avr-libc-logo.png" alt="Logo" align="middle" border="0"></td>
    <td align="right"><a href="https://github.com/avrdudes/avr-libc/"><h2>AVR-LibC Development Pages</h2></a></td>
  </tr>
  <tr>
    <td align="center" width="16%"><a href="index.html"><h2>Main Page</h2></a></td>
    <td align="center" width="16%"><a href="pages.html"><h2>User Manual</h2></a></td>
    <td align="center" width="16%"><a href="modules.html"><h2>Library Reference</h2></a></td>
    <td align="center" width="16%"><a href="FAQ.html"><h2>FAQ</h2></a></td>
    <td align="center" width="16%"><a href="group__demos.html"><h2>Example Projects</h2></a></td>
    <td align="center" width="16%"><a href="files.html"><h2>File List</h2></a></td>
  </tr>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Compiler optimization </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="optim_code_reorder"></a>
Problems with reordering code</h1>
<dl class="section author"><dt>Author</dt><dd>Jan Waclawek</dd></dl>
<p>Programs contain sequences of statements, and a naive compiler would execute them exactly in the order as they are written. But an optimizing compiler is free to <em>reorder</em> the statements &mdash; or even parts of them &mdash; if the resulting "net effect" is the same. The "measure" of the "net effect" is what the standard calls "side
effects", and is accomplished exclusively through accesses (reads and writes) to variables qualified as <code>volatile</code>. So, as long as all volatile reads and writes are to the same addresses and in the same order (and writes write the same values), the program is correct, regardless of other operations in it. One important point to note here is, that time duration between consecutive volatile accesses is not considered at all.</p>
<p>Unfortunately, there are also operations which are not covered by volatile accesses. An example of this in AVR-GCC/AVR-LibC are the <code><a class="el" href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli()</a></code> and <code><a class="el" href="group__avr__interrupts.html#gaad5ebd34cb344c26ac87594f79b06b73">sei()</a></code> macros defined in &lt;<a class="el" href="interrupt_8h.html">avr/interrupt.h</a>&gt;, which convert directly to the respective assembler mnemonics through the <code>__asm__()</code> statement. They constitute a variable access by means of their memory clobber, and they are (implicitly) volatile because they don't have an output operand. So the compiler may not reorder these <a class="el" href="inline_asm.html">inline asm</a> statements with respect to other memory accesses or volatile actions. However, such asm statementy may still be reordered with other statement that are neither volatile nor access memory.</p>
<p><em>Note that even a volatile asm instruction can be moved relative to other code, including across (expensive) arithmetic and jump instructions [...]</em></p>
<dl class="section see"><dt>See also</dt><dd><a href="http://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">http://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html</a></dd></dl>
<p>However, not even a volatile memory barrier like </p><div class="fragment"><div class="line">__asm __volatile__ (<span class="stringliteral">&quot;&quot;</span> ::: <span class="stringliteral">&quot;memory&quot;</span>);</div>
</div><!-- fragment --><p>keeps GCC from reordering non-volatile, non-memory accesses across such barriers. Peter Dannegger provided a nice example of this effect:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define cli() __asm volatile( &quot;cli&quot;</span> ::: &quot;memory&quot; )</div>
<div class="line"><span class="preprocessor">#define sei() __asm volatile( &quot;sei&quot;</span> ::: &quot;memory&quot; )</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ivar;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> test2 (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val)</div>
<div class="line">{</div>
<div class="line">  val = 65535U / val;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli</a>();</div>
<div class="line"> </div>
<div class="line">  ivar = val;</div>
<div class="line"> </div>
<div class="line">  <a class="code hl_define" href="group__avr__interrupts.html#gaad5ebd34cb344c26ac87594f79b06b73">sei</a>();</div>
<div class="line">}</div>
<div class="ttc" id="agroup__avr__interrupts_html_ga68c330e94fe121eba993e5a5973c3162"><div class="ttname"><a href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli</a></div><div class="ttdeci">#define cli()</div><div class="ttdef"><b>Definition:</b> interrupt.h:90</div></div>
<div class="ttc" id="agroup__avr__interrupts_html_gaad5ebd34cb344c26ac87594f79b06b73"><div class="ttname"><a href="group__avr__interrupts.html#gaad5ebd34cb344c26ac87594f79b06b73">sei</a></div><div class="ttdeci">#define sei()</div><div class="ttdef"><b>Definition:</b> interrupt.h:76</div></div>
</div><!-- fragment --><p>avr-gcc v5.4 or v14 compile with optimisations switched on (<code>-Os</code>) to</p>
<pre class="fragment">00000112 &lt;test2&gt;:
 112:	bc 01       	movw	r22, r24
 114:	f8 94       	cli
 116:	8f ef       	ldi	r24, 0xFF	; 255
 118:	9f ef       	ldi	r25, 0xFF	; 255
 11a:	0e 94 96 00 	call	0x12c	; 0x12c &lt;__udivmodhi4&gt;
 11e:	70 93 01 02 	sts	0x0201, r23
 122:	60 93 00 02 	sts	0x0200, r22
 126:	78 94       	sei
 128:	08 95       	ret
</pre><p>where the potentially slow division is moved across <code><a class="el" href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli()</a></code>, resulting in interrupts to be disabled longer than intended. Note, that the volatile access occurs in order with respect to <code><a class="el" href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli()</a></code> or <code><a class="el" href="group__avr__interrupts.html#gaad5ebd34cb344c26ac87594f79b06b73">sei()</a></code>; so the "net effect" required by the standard is achieved as intended, it is "only" the timing which is off. However, for most of embedded applications, timing is an important, sometimes critical factor.</p>
<dl class="section see"><dt>See also</dt><dd><a href="https://www.mikrocontroller.net/topic/65923">https://www.mikrocontroller.net/topic/65923</a></dd></dl>
<p>Unfortunately, at the moment, in avr-gcc (nor in the C standard), there is no mechanism to enforce complete match of written and executed code ordering &mdash; except maybe of switching the optimization completely off (<code>-O0</code>), or writing all the critical code in assembly.</p>
<dl class="section note"><dt>Note</dt><dd>The artifact with the <code>__udivmodhi4</code> function is specific to avr-gcc and how the compiler represents the division internally. On other target platforms that are using a library function for division or whatever expensive operation, this eccect will not occur. The reason is that avr-gcc does not represent the library call as a function call but rather like an ordinary instruction. Outcome is that the GCC middle-end concludes that the division is cheap (because the backend has an instruction for it) but in fact it's not.</dd></dl>
<p>A work around for the code from above would be to enforce that the division havvens prior to the <code><a class="el" href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli()</a></code>: </p><div class="fragment"><div class="line">val = 65535U / val;</div>
<div class="line">__asm __volatile__ (<span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;+r&quot;</span> (val));</div>
<div class="line"><a class="code hl_define" href="group__avr__interrupts.html#ga68c330e94fe121eba993e5a5973c3162">cli</a>();</div>
</div><!-- fragment --><ul>
<li>The <code>volatile</code> forces the asm statememt prior to the <code>cli</code>.</li>
<li>The asm has <code>val</code> as input operand, hence the division must be carried out prior to the asm because <code>val</code> is set by the division.</li>
</ul>
<p>Notice that this work around does not work in general due to a variety of reasons:</p>
<ul>
<li>The division might be located in an inlined function.</li>
<li>The variable might be read-only or may not be appropriate as an asm operand.</li>
<li>There may be more such instruction prior to the division, and it is not practical to treat all of them like this.</li>
</ul>
<p>To sum it up:</p>
<ul>
<li>volatile memory barriers don't ensure statements with no volatile accesses to be reordered across the barrier </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 9 2024 00:30:42 for AVR-LibC by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.9.6
</small></address>
</body>
</html>
